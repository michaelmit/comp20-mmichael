<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Assign-2</title>
    <!-- Using Google Maps API, Geolocator and JSON -->
    <link rel="stylesheet" type="text/css" href="mystyle.css"/> 
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>

</head>
    <!-- <body onload="loadMessages()"> -->
    <body>
    <section>
            <h1>Messages</h1>
            <div id="messages">Loading...</div>
    </section>

    <!-- space to display the map -->
    <!-- <div id="map-canvas"></div> -->
    <div id="map-canvas" style="clear:both; height:500px;"></div> 


    <script>
    // callbalk to retrieve my position
    // retrieve my position using Geolocator

    // var myPos;
    // function geoCallback (position) {
    //     navigator.geolocation.getCurrentPosition(geoCallback);
    //     myPos = position.coords;
    //     console.log('Your current position is:');
    //     console.log(`Latitude : ${myPos.latitude}`);
    //     console.log(`Longitude: ${myPos.longitude}`);
    // }


    var myPos = {};
    var map;
    var messages;
    var created = false;
    var request;

    // XMLHttp Request
    function loadMessages() {


            // navigator.geolocation.getCurrentPosition(geoCallback);
            // function geoCallback (position) {
            //     myPos = position.coords;
            //     console.log('Your current position is:');
            //     console.log(`Latitude : ${myPos.latitude}`);
            //     console.log(`Longitude: ${myPos.longitude}`);
            // }



			// Step 1: Make an instance of XMLHttpRequest
			request = new XMLHttpRequest();
			// Step 2: Set up HTTP request
			request.open("POST", "https://defense-in-derpth.herokuapp.com/sendLocation", true);

            // request.send('param1=val1&param2=val2&param3=val3')
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

			// Step 3: Set up callback on what to do when response is received
	        request.onreadystatechange = function() {
       	        // Step 3A: get the response text if and only if readyState is 4
			    if (request.readyState == 4 && request.status == 200) {
                    console.log("success");
                    // Step 5: do something with the response data (i.e., the JSON)
                    rawData = request.responseText;

                    messages = JSON.parse(rawData);

                    console.log(messages);
                    if(typeof messages =='object')
                    {
                        console.log("It is JSON");
                    }
                    if(typeof messages == 'string')
                    {
                        console.log("It is String");
                    }

                    console.log(rawData.length);
                    // output = "<ul>";
                    // for (count = 0; count < messages.length; count++) {
                    //     output += "<li>" + messages[count].content + " => " + messages[count].username + "</li>";
                    // }
                    // output += "</ul>";
                    // document.getElementById("messages").innerHTML = output;

                    output = "<ul>";
                    for (count = 0; count < 10; count++) {
                        {

                            // output += "<li>" + "howdy" + "</li>" ;
                            // for (i = 0; i < rawData["people"].length; i++) {
                                 output += "<li>" + (messages['people'])[count]['login'] + "</li>" ;

                        }
                        // output += "<li>" + messages[count].people + " => " + messages[count].username + "</li>";
                    }
                    output += "</ul>";
                    document.getElementById("messages").innerHTML = output;

                    // moving map creation here temporarily
                    created = true;
                    console.log("created is:", created);

                    initialize();


                }
            }
			// Step 4: Fire off the request
            // var postMdg = JSON.stringify({ login: "KzQy5Jj1", lat : myPos.latitute, lng : myPos.longitude });
            // request.send(postMsg);

            myPos.latitude  = 42.4118037;
            myPos.longitude = -71.11929529999999;

            var la = "42.4118037";
            var lo = "-71.11929529999999";

            var params = "login=KzQy5Jj1&lat="+la+"&lng="+lo;
            request.send(params);
            // var params = "login=&=binny";


            // console.log('Your current position is:');
            // console.log(`Latitude : ${myPos.latitude}`);
            // console.log(`Longitude: ${myPos.longitude}`);
        }

        // ******************************************************************
        /*
        * The code below will initialize a google maps view
        * and center it at my geo-location.
        * Map is placed on html div# "my-canvas"
        * CSS for map is defined in css style sheet
        */
        function initialize() {
            var mapOptions = {
            center: new google.maps.LatLng(myPos.latitude, myPos.longitude),
            zoom: 13,
            mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            //  Setup map object  - uses mapOptions
            var map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);


            // ****************************************************************

            // variable that sets the URL to the new image
            var icon_person = {
                url: "img/map-marker-person-1.png", // url
                scaledSize: new google.maps.Size(50, 50), // scaled size
                origin: new google.maps.Point(0,0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };

            // variable that sets the URL to the new image
            var icon_landmark = {
                url: "img/map-marker-place-1.png", // url
                scaledSize: new google.maps.Size(35, 35), // scaled size
                origin: new google.maps.Point(0,0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };



            // ****************************************************************
            if (request.readyState == 4 && request.status == 200) {
                console.log("in map, created is:", created);
            }
            if (messages != null) {
                var land_len = (messages['people']).length; // length of array of objects
                console.log("length of people array obj" , land_len);
            }
            for (var prop in messages['landmarks']) { // each object
                if (! messages['landmarks'].hasOwnProperty(prop)) {
                     continue;
                }
                // Get Attributes for each Landmark
                var getLng = messages['landmarks'][prop]['geometry']['coordinates'][0]; // Longitude
                var getLat  = messages['landmarks'][prop]['geometry']['coordinates'][1]; // Latitude
                var latlng = new google.maps.LatLng(getLat, getLng); // Google Maps position object
                var getName  = messages['landmarks'][prop]['properties']['Location_Name']; // Loc_Name
                var getDesc  = messages['landmarks'][prop]['properties']['Details']; // Loc_Description
                createMarker(latlng, getName, getDesc);

                // this variable sets the map bounds and zoom level according to markers position
                var bounds = new google.maps.LatLngBounds();
                // Marker’s Lat. and Lng. values are added to bounds variable
                bounds.extend(latlng);

            }

            // Finally the bounds variable is used to set the map bounds
            // with API’s fitBounds() function
            map.fitBounds(bounds);




            // ****************************************************************
            // This function creates each marker and sets their Info Window content
            function createMarker(latlng, name, description){
            var marker = new google.maps.Marker({
                map: map,
                position: latlng,
                title: name,
                icon: icon_landmark // set new image
            });

            // This event expects a click on a marker
            // When this event is fired the infowindow content is created
            // and the infowindow is opened
            google.maps.event.addListener(marker, 'click', function() {
                
                // Variable to define the HTML content to be inserted in the infowindow
                var iwContent = '<div id="iw_container">' +
                '<div class="iw_title">' + name + '</div>' +
                '<div class="iw_content">' + description + '<br />' +
                
                // including content to the infowindow
                infoWindow.setContent(iwContent);

                // opening the infowindow in the current map and at the current marker location
                infoWindow.open(map, marker);
            });
            }
            // ****************************************************************

            // my position marker 
            var marker_myPos = new google.maps.Marker({
                position: mapOptions.center,
                map: map,
                title:"My Location in Medford",
                icon: icon_person // set new image
            });

            var marker_land = new google.maps.Marker({
                position: mapOptions.center,
                map: map,
                title: getName, 
                icon: icon_landmark // set new image
            });




            // my infoWindow
            var myContent = '<div id="iw_container">' +
            '<div class="iw_title">My Location</div>' +
            '<div class="iw_content">Green Treelined Residential Avenue' +
            '</div>';

            // ****************************************************************

            var infowindow = new google.maps.InfoWindow({
                content: myContent
            });

            google.maps.event.addListener(marker_myPos, 'click', function() {
            infowindow.open(map,marker_myPos);
            });

            // event to close the infoWindow with a click on the map
            google.maps.event.addListener(map, 'click', function() {
            infowindow.close();
            });


        }
        // google.maps.event.addDomListener(window, 'load', initialize);
        google.maps.event.addDomListener(window, 'load', loadMessages);



        // ******************************************************************


        // ******************************************************************
        /*
        * The code below will add a marker for my geo-location 
        * A custom icon is used that represents all people on this map
        */





    </script>
    
</body>
</html>